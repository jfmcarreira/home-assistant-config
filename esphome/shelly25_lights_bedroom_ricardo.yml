substitutions:
  DeviceName: shelly25_lights_bedroom_ricardo
  PowerSaveMode: LIGHT
  FriendlyName: Shelly25 Bedroom Ricardo
  InputPin: GPIO5
  Light_A_Name: Bedroom Ricardo Ceiling
  Light_B_Name: Bedroom Ricardo Closet
  Address: !secret shelly25_bedroom_ricardo_ip

<<: !include includes/shelly25_base_two_lights.yml


globals:
  - id: lights_state
    type: int
    restore_value: no
    initial_value: '0'


script:
  - id: smart_light_state
    then:
      - globals.set:
          id: lights_state
          value: !lambda "return id(lights_state)+=1;"
      - if:
          condition:
            lambda: 'return id(lights_state) > 2;'
          then:
             - globals.set:
                id: lights_state
                value: "0"

      - if:
          condition:
            lambda: 'return id(lights_state) == 0;'
          then:
            - light.turn_on: light_1
            - light.turn_on: light_2
            - homeassistant.service:
                service: light.turn_off
                data:
                  entity_id: light.bedroom_ricardo_lamp
      - if:
          condition:
            lambda: 'return id(lights_state) == 1;'
          then:
            - light.turn_on: light_1
            - light.turn_off: light_2
            - homeassistant.service:
                service: light.turn_off
                data:
                  entity_id: light.bedroom_ricardo_lamp

      - if:
          condition:
            lambda: 'return id(lights_state) == 2;'
          then:
            - light.turn_off: light_1
            - light.turn_off: light_2
            - homeassistant.service:
                service: light.turn_on
                data:
                  entity_id: light.bedroom_ricardo_lamp




binary_sensor:
  - platform: homeassistant
    id: house_mode_night
    entity_id: binary_sensor.night_mode

  - platform: homeassistant
    id: bedroom_ricardo_lamp_state
    entity_id: light.bedroom_ricardo_lamp

  - id: sw_1
    platform: gpio
    pin: ${InputPin}
    on_multi_click:
      - timing:
          - ON for at most 1000ms
          - OFF for at least 100ms
        then:
          - if:
              condition:
                or:
                  - light.is_on: light_1
                  - light.is_on: light_2
                  - binary_sensor.is_on: bedroom_ricardo_lamp_state
              then:
                - light.turn_off: light_1
                - light.turn_off: light_2
                - homeassistant.service:
                    service: light.turn_off
                    data:
                      entity_id: light.bedroom_ricardo_lamp
              else:
                - if:
                    condition:
                      and:
                        - api.connected:
                        - binary_sensor.is_on: house_mode_night
                    then:
                      - light.turn_on: light_1
                      - globals.set:
                          id: lights_state
                          value: "1"
                    else:
                      - light.turn_on: light_1
                      - light.turn_on: light_2
                      - globals.set:
                          id: lights_state
                          value: "0"
      - timing:
          - ON for at least 1000ms
        then:
          - if:
              condition:
                - api.connected:
              then:
                - script.execute: smart_light_state