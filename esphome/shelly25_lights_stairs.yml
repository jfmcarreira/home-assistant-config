substitutions:
  DeviceName: shelly25_lights_stairs
  PowerSaveMode: HIGH
  FriendlyName: Shelly25 Stairs
  Light_A_Name: Stairs Lamp
  Light_B_Name: Stairs Wall

packages:
  esphome_base: !include packages/common.yml
  home_state: !include packages/home_state.yml
  device_base: !include packages/shelly25_lights.yml

output:
  - platform: gpio
    id: relay_1
    pin: GPIO15
  - platform: gpio
    id: relay_2
    pin: GPIO04

light:
  - id: light_1
    name: ${Light_A_Name}
    platform: binary
    output: relay_1
    restore_mode: RESTORE_AND_OFF

  - id: light_2
    name: ${Light_B_Name}
    platform: binary
    output: relay_2
    restore_mode: RESTORE_AND_OFF

binary_sensor:
  - platform: homeassistant
    id: stairs_down_state
    entity_id: light.stairs_down

  - id: sw_1
    platform: gpio
    pin: GPIO05
    on_multi_click:
      - timing:
          - ON for at most 1000ms
          - OFF for at least 100ms
        invalid_cooldown: 100ms
        then:
          - if:
              condition:
                - api.connected:
              then:
                - if:
                    condition:
                      or:
                        - light.is_on: light_2
                        - binary_sensor.is_on: stairs_down_state
                    then:
                      - light.turn_off: light_2
                      - homeassistant.service:
                          service: light.turn_off
                          data:
                            entity_id: light.stairs_down
                    else:
                      - homeassistant.service:
                          service: light.turn_on
                          data:
                            entity_id: light.stairs_down
              else:
                - light.toggle: light_2
      - timing:
          - ON for at least 1000ms
        invalid_cooldown: 10ms
        then:
          - if:
              condition:
                - api.connected:
              then:
                - light.toggle: light_1
              else:
                - light.toggle: light_1

  - id: sw_2
    platform: gpio
    pin: GPIO13
    on_multi_click:
      - timing:
          - ON for at most 1000ms
          - OFF for at least 10ms
        invalid_cooldown: 10ms
        then:
          - if:
              condition:
                and:
                  - api.connected:
              then:
                - light.toggle: light_2
              else:
                - light.toggle: light_2

      - timing:
          - ON for at least 1000ms
        invalid_cooldown: 10ms
        then:
          - if:
              condition:
                and:
                  - api.connected:
              then:
                - light.toggle: light_2
              else:
                - light.toggle: light_2
