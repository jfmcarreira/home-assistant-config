################################################################
## Cat Litter
################################################################
homeassistant:
  customize:      
    counter.cat_litter_box_visits:
      friendly_name: Litter Box Visits
      
counter:
  cat_litter_box_visits:
    step: 1
    icon: "mdi:cat"
    
input_datetime:
  cat_litter_box_last_visit:
    name: Litter Box Last Visit
    icon: mdi:clock-outline
    has_date: true
    has_time: true
  cat_litter_box_last_clean:
    name: Litter Box Last Clean
    icon: mdi:clock-outline
    has_date: true
    has_time: true
  cat_litter_box_last_change:
    name: Litter Box Last Change
    icon: mdi:clock-outline
    has_date: true
    has_time: false
   
          
sensor:
  - platform: template
    sensors:
      cat_litter_box_last_visit:
        friendly_name: "Litter Box Last Visit"
        device_class: timestamp
        value_template: >
          {{ state_attr('input_datetime.cat_litter_box_last_visit', 'timestamp') | timestamp_custom("%Y-%m-%d %H:%M:%S", true) }}
      cat_litter_box_last_clean:
        friendly_name: "Litter Box Last Clean"
        device_class: timestamp
        value_template: >
          {{ state_attr('input_datetime.cat_litter_box_last_clean', 'timestamp') | timestamp_custom("%Y-%m-%d %H:%M", true) }}
      cat_litter_box_last_change:
        friendly_name: "Litter Box Last Change"
        device_class: timestamp
        value_template: >
          {{ state_attr('input_datetime.cat_litter_box_last_change', 'timestamp') | timestamp_custom("%Y-%m-%d", true) }}


automation old:
  - id: Cat Reset PIR State
    alias: Cat Reset PIR State
    initial_state: true
    trigger:
    - platform: homeassistant
      event: start
    - platform: state
      entity_id: binary_sensor.litter_box_motion
      from: 'off'
      to: 'on'
      for:
        seconds: 120
    action:
    - service: mqtt.publish
      data:
        topic: binary_rf_sensors/litter_box_motion
        payload: 'OFF'

  - id: Cat Litter Mark Visit
    alias: Cat Litter Mark Visit
    trigger:
    - entity_id: binary_sensor.litter_box_motion
      from: 'off'
      platform: state
      to: 'on'
    action:
    - service: script.cat_litter_visit
    initial_state: true

script:
  cat_litter_visit:
    alias: "Litter Box Mark Visit"
    sequence:
      - service: counter.increment
        data:
          entity_id: counter.cat_litter_box_visits
      - service: input_datetime.set_datetime
        data_template:
          entity_id: input_datetime.cat_litter_box_last_visit
          date: '{{ now().timestamp() | timestamp_custom("%Y-%m-%d", true) }}'
          time: '{{ now().timestamp() | timestamp_custom("%H:%M:%S", true) }}'

  cat_litter_clean:
    alias: "Litter Box Mark Clean"
    sequence:
      - service: counter.reset
        data:
          entity_id: counter.cat_litter_box_visits

      - service: input_datetime.set_datetime
        data_template:
          entity_id: input_datetime.cat_litter_box_last_clean
          date: '{{ now().timestamp() | timestamp_custom("%Y-%m-%d", true) }}'
          time: '{{ now().timestamp() | timestamp_custom("%H:%M", true) }}'

      - service: grocy.execute_chore
        data:
          chore_id: 1

  cat_litter_change:
    alias: "Litter Box Mark Change"
    sequence:
      - service: script.cat_litter_clean
      - service: grocy.execute_chore
        data:
          chore_id: 2
      - service: input_datetime.set_datetime
        data_template:
          entity_id: input_datetime.cat_litter_box_last_change
          date: '{{ now().timestamp() | timestamp_custom("%Y-%m-%d", true) }}'
