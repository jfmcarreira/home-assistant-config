################################################################
## Reolink E1 Pro Camera
################################################################
input_boolean:
  baby_monitor_high_quality:
    name: Qualidade Baby Monitor
  baby_monitor_broadcast_office:
    name: Reproduzir Baby Monitor no EscritÃ³rio
  baby_monitor_broadcast_living_room:
    name: Reproduzir Baby Monitor na Sala
  baby_monitor_broadcast_master_bedroom:
    name: Reproduzir Baby Monitor no Quarto
  baby_monitor_notify_joao:
    name: Notificar Joao
  baby_monitor_notify_bianca:
    name: Reproduzir Bianca

# camera:
#   - platform: ffmpeg
#     name: Baby Monitor
#     input: !secret reolinke1pro

#   - platform: ffmpeg
#     name: Baby Monitor Low
#     input: !secret reolinke1pro_low

binary_sensor:
  - platform: ffmpeg_noise
    name: Baby Monitor Noise
    input: !secret reolinke1pro_sensors
    #    extra_arguments:
    initial_state: false
    duration: 2
    reset: 10
    peak: -42

  - platform: ffmpeg_motion
    name: Baby Monitor Motion
    input: !secret reolinke1pro_sensors
    #extra_arguments: -filter:v "crop=367:190:163:162"
    initial_state: false
    changes: 5
    reset: 10

automation:
  - alias: "Baby Monitor Change State"
    trigger:
      - platform: state
        entity_id: input_boolean.ricardo_sleeping
      - platform: homeassistant
        event: start
    action:
      - choose:
          - conditions: "{{ states.input_boolean.ricardo_sleeping.state == 'on' }}"
            sequence:
              - service: ffmpeg.start
                entity_id: binary_sensor.baby_monitor_noise
              - service: ffmpeg.start
                entity_id: binary_sensor.baby_monitor_motion
        default:
          - service: ffmpeg.stop
            entity_id: binary_sensor.baby_monitor_noise
          - service: ffmpeg.stop
            entity_id: binary_sensor.baby_monitor_motion
          - service: input_boolean.turn_off
            entity_id: input_boolean.baby_monitor_broadcast_office
          - service: input_boolean.turn_off
            entity_id: input_boolean.baby_monitor_broadcast_living_room
          - service: input_boolean.turn_off
            entity_id: input_boolean.baby_monitor_broadcast_master_bedroom
          - service: input_boolean.turn_off
            entity_id: input_boolean.baby_monitor_notify_joao
          - service: input_boolean.turn_off
            entity_id: input_boolean.baby_monitor_notify_bianca

  - alias: "Baby Monitor Restart"
    trigger:
      - platform: state
        entity_id: binary_sensor.baby_monitor_noise
        to: "unavailable"
    condition:
      - condition: state
        entity_id: input_boolean.ricardo_sleeping
        state: "on"
    action:
      - service: ffmpeg.stop
        entity_id: binary_sensor.baby_monitor_noise
      - service: automation.turn_off
        entity_id: automation.baby_monitor_start_broadcast
      - service: ffmpeg.start
        entity_id: binary_sensor.baby_monitor_noise
      - service: automation.turn_on
        entity_id: automation.baby_monitor_start_broadcast

  - alias: "Baby Monitor Start Broadcast"
    mode: single
    trigger:
      - platform: state
        entity_id: binary_sensor.baby_monitor_noise
        from: "off"
        to: "on"
      - platform: state
        entity_id: binary_sensor.baby_monitor_motion
        from: "off"
        to: "on"
      - platform: state
        entity_id: binary_sensor.baby_monitor_motion_sensor
        from: "off"
        to: "on"
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: input_boolean.ricardo_sleeping
          state: "on"
        - condition: template
          value_template: "{{ (as_timestamp(now()) - as_timestamp((states.input_boolean.ricardo_sleeping.last_updated)) > 60 ) }}"
    action:
      - choose:
          - conditions: "{{ states.input_boolean.baby_monitor_notify_joao.state == 'on' }}"
            sequence:
              - service: notify.mobile_app_magnesium
                data:
                  title: Baby Monitor
                  message: Atividade Detectada (Som/Movimento)
                  data:
                    image: /api/camera_proxy/camera.baby_monitor_onvif
                    tag: 91
                    priority: high
                    channel: Events
                    clickAction: /lovelace/households
                    hide-thumbnail: false
      - choose:
          - conditions: "{{ states.input_boolean.baby_monitor_notify_bianca.state == 'on' }}"
            sequence:
              - service: notify.mobile_app_calcium
                data:
                  title: Baby Monitor
                  message: Atividade Detectada (Som/Movimento)
                  data:
                    tag: 91
                    priority: high
                    channel: Events
                    clickAction: /lovelace/households
      - choose:
          - conditions: "{{ states.input_boolean.baby_monitor_broadcast_master_bedroom.state == 'on' }}"
            sequence:
              - service: camera.play_stream
                data:
                  entity_id: camera.baby_monitor_low
                  media_player: media_player.ghm_master_bedroom
              - service: media_player.volume_set
                data:
                  entity_id: media_player.ghm_master_bedroom
                  volume_level: >
                    {% if now().strftime("%H")|int < 23 and now().strftime("%H")|int > 7 %}
                      {{ ( states( 'input_number.google_home_volume_tts_day' ) | int ) / 100 }}
                    {% else %}
                      {{ ( states( 'input_number.google_home_volume_tts_night' ) | int ) / 100 }}
                    {% endif %}

      - choose:
          - conditions: "{{ states.input_boolean.baby_monitor_broadcast_living_room.state == 'on' }}"
            sequence:
              - service: camera.play_stream
                data:
                  entity_id: camera.baby_monitor_low
                  media_player: media_player.ghm_living_room
              - service: media_player.volume_set
                data:
                  entity_id: media_player.ghm_living_room
                  volume_level: >
                    {% if now().strftime("%H")|int < 23 and now().strftime("%H")|int > 7 %}
                      {{ ( states( 'input_number.google_home_volume_tts_day' ) | int ) / 100 }}
                    {% else %}
                      {{ ( states( 'input_number.google_home_volume_tts_night' ) | int ) / 100 }}
                    {% endif %}
      - choose:
          - conditions: "{{ states.input_boolean.baby_monitor_broadcast_office.state == 'on' }}"
            sequence:
              - service: camera.play_stream
                data:
                  entity_id: camera.baby_monitor_low
                  media_player: media_player.ghm_office
              - service: media_player.volume_set
                data:
                  entity_id: media_player.ghm_office
                  volume_level: >
                    {% if now().strftime("%H")|int < 23 and now().strftime("%H")|int > 7 %}
                      {{ ( states( 'input_number.google_home_volume_tts_day' ) | int ) / 100 }}
                    {% else %}
                      {{ ( states( 'input_number.google_home_volume_tts_night' ) | int ) / 100 }}
                    {% endif %}

  - alias: "Baby Monitor Stop Broadcast"
    mode: single
    trigger:
      - platform: state
        entity_id: binary_sensor.baby_monitor_noise
        from: "on"
        to: "off"
        for:
          minutes: 10
      - platform: state
        entity_id: input_boolean.ricardo_sleeping
        from: "on"
        to: "off"
    action:
      - choose:
          - conditions: "{{ not ( states.media_player.ghm_master_bedroom.state == 'off' ) }}"
            sequence:
              - service: media_player.turn_off
                entity_id: media_player.ghm_master_bedroom

      - choose:
          - conditions: "{{ not ( states.media_player.ghm_living_room.state == 'off' ) }}"
            sequence:
              - service: media_player.turn_off
                entity_id: media_player.ghm_living_room

      - choose:
          - conditions: "{{ not ( states.media_player.ghm_office.state == 'off' ) }}"
            sequence:
              - service: media_player.turn_off
                entity_id: media_player.ghm_office
#image_processing:
#- platform: opencv
#source:
#- entity_id: camera.baby_monitor_ffmpeg_detector
#name: Baby Monitor Detector Opencv
#classifier:
#face_frontal:
#file: /config/opencv/haarcascade_frontalface_default.xml
#neighbors: 2
#min_size:
#- 5
#- 5
#face_profile:
#file: /config/opencv/haarcascade_profileface.xml
#neighbors: 2
#min_size:
#- 5
#- 5
#upper_body:
#file: /config/opencv/haarcascade_upperbody.xml
#neighbors: 2
#min_size:
#- 5
#- 5

#- platform: dlib_face_detect
#source:
#- entity_id: camera.baby_monitor
#name: Baby Monitor Detector DLib

#camera:
#- platform: reolink_dev
#host: !secret reolinke1pro_ip
#username: !secret reolinke1pro_user
#password: !secret reolinke1pro_pass
#name: Baby Monitor Reolink
#stream: main
#protocol: rtmp
#scan_interval: 5

#binary_sensor:
#- platform: template
#sensors:
#motion_baby_monitor:
#friendly_name:  Baby Monitor
#device_class: motion
#value_template: "{{ is_state('camera.baby_monitor_reolink', 'motion') }}"
#delay_off:
#seconds: 15
