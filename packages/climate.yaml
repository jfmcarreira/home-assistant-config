################################################################
## Heating
################################################################
climate:
  - platform: generic_thermostat
    name: Heating
    heater: switch.sonoff_basic_heating_relay
    target_sensor: sensor.heating_temperature
    min_temp: 10
    max_temp: 24
    min_cycle_duration:
      minutes: 1
    initial_hvac_mode: "off"
    cold_tolerance: 0
    hot_tolerance: 0.5
    keep_alive:
      minutes: 3

################################################################
## Heating temperature selection
################################################################
input_select:
  heating_temperature_selection:
    name: Heating temperature
    options:
      - Living Room
      - Bedroom
      - Office/Portable
    initial: Living Room
    icon: mdi:target

sensor:
  - platform: template
    sensors:
      heating_temperature:
        friendly_name: "Heating Temperature"
        device_class: temperature
        value_template: >
          {% if is_state("input_select.heating_temperature_selection", "Living Room") %} 
            {{ states( 'sensor.living_room_temperature' ) }}
          {% elif is_state("input_select.heating_temperature_selection", "Bedroom") %} 
            {{ states( 'sensor.master_bedroom_temperature' ) }}
          {% else %}
            {{ states( 'sensor.mijia_office_temperature' ) }}
          {% endif %}
        entity_id:
          - input_select.heating_temperature_selection
          - sensor.living_room_temperature
          - sensor.master_bedroom_temperature
          - sensor.mijia_office_temperature

################################################
## Heating Off Time
################################################
input_datetime:
  heating_off_working_days:
    has_time: true
    has_date: false
  heating_off_weekend_days:
    has_time: true
    has_date: false

################################################
## Automation
################################################
automation old:
  - id: Heating Notify state
    alias: Heating Notify state
    trigger:
      - platform: state
        entity_id: switch.sonoff_basic_heating_relay
    action:
      - service: notify.mobile_app_oneplus_a6010
        data_template:
          message: >
            {% if is_state('switch.sonoff_basic_heating_relay' , 'on') %}
              Aquecimento ligado
            {% else %}
              Aquecimento desligado
            {% endif %}

  - id: Heating Auto Turn Off - Working Days
    alias: Heating Auto Turn Off - Working Days
    trigger:
      - platform: template
        value_template: "{{ states.sensor.time.state == (states.input_datetime.heating_off_working_days.attributes.timestamp | int | timestamp_custom('%H:%M', False)) }}"
    condition:
      - condition: template
        value_template: >
          {% if (states.input_datetime.heating_off_working_days.attributes.timestamp | int ) < 28800 %} # Check if timestamp is <8am
              {{ is_state('binary_sensor.workday', 'on') }}
          {% else %}
              {{ is_state('binary_sensor.workday_tomorrow', 'on') }}
          {% endif %}
    action:
      - service: climate.turn_off
        entity_id: climate.heating

  - id: Heating Auto Turn Off - Weekend
    alias: Heating Auto Turn Off - Weekend
    trigger:
      - platform: template
        value_template: "{{ states.sensor.time.state == (states.input_datetime.heating_off_weekend_days.attributes.timestamp | int | timestamp_custom('%H:%M', False)) }}"
    condition:
      - condition: template
        value_template: >
          {% if (states.input_datetime.heating_off_weekend_days.attributes.timestamp | int ) < 28800 %} # Check if timestamp is <8am
              {{ is_state('binary_sensor.workday', 'off') }}
          {% else %}
              {{ is_state('binary_sensor.workday_tomorrow', 'off') }}
          {% endif %}
    action:
      - service: climate.turn_off
        entity_id: climate.heating
