automation:
  - id: "1701986636577"
    alias: Abrir Portão Alguém Chegar a Casa
    description: ""
    mode: single
    trigger:
      - platform: numeric_state
        entity_id:
          - proximity.distance_home_bianca
          - proximity.distance_home_joao
        for:
          hours: 0
          minutes: 0
          seconds: 2
        below: 300
      - platform: state
        entity_id:
          - binary_sensor.bianca_home
          - binary_sensor.joao_home
        from: "off"
        to: "on"
    condition: []
    action:
      - if:
          - condition: state
            entity_id: cover.gate
            state: closed
          - condition: or
            conditions:
              - condition: and
                conditions:
                  - condition: state
                    entity_id: binary_sensor.bianca_home_with_hysteresis
                    state: "off"
                  - condition: or
                    conditions:
                      - condition: and
                        conditions:
                          - condition: numeric_state
                            entity_id: proximity.distance_home_bianca
                            below: 300
                          - condition: state
                            entity_id: proximity.distance_home_bianca
                            attribute: dir_of_travel
                            state: towards
                      - condition: state
                        entity_id: binary_sensor.bianca_home
                        state: "on"
              - and:
                  - condition: state
                    entity_id: binary_sensor.joao_home_with_hysteresis
                    state: "off"
                  - condition: or
                    conditions:
                      - condition: and
                        conditions:
                          - condition: numeric_state
                            entity_id: proximity.distance_home_joao
                            below: 300
                          - condition: state
                            entity_id: proximity.distance_home_joao
                            attribute: dir_of_travel
                            state: towards
                      - condition: state
                        entity_id: binary_sensor.joao_home
                        state: "on"
        then:
          - service: cover.open_cover
            target:
              entity_id: cover.gate
            data: {}
      - if:
          - condition: state
            entity_id: binary_sensor.bianca_home
            state: "on"
        then:
          - service: input_boolean.turn_off
            target:
              entity_id: input_boolean.going_home_bianca
            data: {}
      - if:
          - condition: state
            entity_id: binary_sensor.joao_home
            state: "on"
        then:
          - service: input_boolean.turn_off
            target:
              entity_id: input_boolean.going_home_joao
            data: {}
      - delay:
          seconds: 10
