automation insert:
  - id: "Daily Stats Insert Value of Energy to Database"
    alias: "Daily Stats Insert Value of Energy to Database"
    initial_state: true
    trigger:
      - platform: state
        entity_id: sensor.daily_energy
    action:
      - service: shell_command.external_my_sql_insert
        data_template:
          table: daily_energy
          value: >
            {{ states.sensor.daily_energy.state }}
            
            
sensor:
  - platform: sql
    db_url: !secret db_custom_url
    queries:
      - name: query_daily_energy_current_month
        column: "value"
        query: >-
          SELECT
              CONCAT('[', GROUP_CONCAT(DAY(date) SEPARATOR ','),']') AS labels,
              CONCAT('[', GROUP_CONCAT(value SEPARATOR ','),']') AS data,
              CONCAT('["', GROUP_CONCAT(IF(`value` > 12, 'red', IF(`value` > 6, 'orange', 'green')) SEPARATOR '","'),'"]') AS colors,
              ROUND(SUM(value), 2) AS total,
              'info in attributes' AS value
          FROM daily_energy
          WHERE MONTH(date) = MONTH(CURRENT_DATE);
        
      - name: query_daily_energy_current_year
        column: "attributes"
        query: >-
          SELECT
              CONCAT('[', GROUP_CONCAT(month SEPARATOR ','), ']') AS labels,
              CONCAT('[', GROUP_CONCAT(total SEPARATOR ','), ']') AS data,
              'info in attributes' AS 'attributes'
          FROM
          (
            SELECT
              ROUND(SUM(`value`), 2) AS total,
              CONCAT('"',MONTHNAME(date), ' ', YEAR(date),'"') AS month
            FROM `daily_energy`
            GROUP BY MONTH(date)
            ORDER BY date
            LIMIT 12
          ) AS json;
