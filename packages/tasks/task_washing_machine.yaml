################################################################
## Washing Machine and Laundry Tasks
################################################################
homeassistant:
  customize:
    binary_sensor.washing_machine_door:
      icon: mdi:washing-machine
      friendly_name: Porta da Máquina de Lavar
    binary_sensor.washing_machine_state:
      icon: mdi:washing-machine

binary_sensor state:
  - platform: mqtt
    name: "Washing Machine Door"
  
    device_class: door
    state_topic: "binary_rf_sensors/wash_machine_door"
    qos: 1

  - platform: template
    sensors:
      washing_machine_state:
        friendly_name: "Máquina de Lavar"
        device_class: plug
        delay_off:
          minutes: 5
        #entity_id:
          #- sensor.power_sensor_laundry
          #- sensor.power_sensor_laundry_reactive
        value_template: >-
          {%- if ( states("sensor.power_sensor_laundry") | int > 25 ) and ( states("sensor.power_sensor_laundry_reactive") | float | abs > 50 ) %}
              True
          {%- else %}
              False
          {%- endif %}
        attribute_templates:
          Última Lavagem: >
            {{ as_timestamp( states('input_datetime.task_washing_clothes_last_done') ) | timestamp_custom("%Y-%m-%d %H:%M:%S", true) }}
  

automation state:
- alias: Reset PIR State Washing Machine Door
  initial_state: true
  trigger:
    - platform: homeassistant
      event: start
    - platform: state
      entity_id: binary_sensor.washing_machine_door
      to: "on"
      for:
        seconds: 60
  action:
    - service: mqtt.publish
      data:
        topic: "binary_rf_sensors/wash_machine_door"
        payload: "OFF"

input_datetime:
  task_washing_clothes_last_done:
    name: Lavar Roupa
    icon: mdi:clock-outline
    has_date: true
    has_time: true
  task_washing_clothes_dry_last_done:
    name: Estender Roupa
    icon: mdi:clock-outline
    has_date: true
    has_time: true
  task_washing_clothes_remove_last_done:
    name: Apanhar Roupa
    icon: mdi:clock-outline
    has_date: true
    has_time: true
    
    
sensor clothes:
  - platform: template
    sensors:
      task_washing_clothes_last_done:
        friendly_name: Lavar Roupa
        device_class: timestamp
        icon_template: mdi:washing-machine
        value_template: >
          {{ state_attr('input_datetime.task_washing_clothes_last_done', 'timestamp') | timestamp_custom("%Y-%m-%d %H:%M", true) }}
      task_washing_clothes_dry_last_done:
        friendly_name: Estender Roupa
        device_class: timestamp
        icon_template: mdi:hanger
        value_template: >
          {{ state_attr('input_datetime.task_washing_clothes_dry_last_done', 'timestamp') | timestamp_custom("%Y-%m-%d %H:%M", true) }}
      task_washing_clothes_remove_last_done:
        friendly_name: Apanhar Roupa
        device_class: timestamp
        icon_template: mdi:tshirt-crew
        value_template: >
          {{ state_attr('input_datetime.task_washing_clothes_remove_last_done', 'timestamp') | timestamp_custom("%Y-%m-%d %H:%M", true) }}
          
          

binary_sensor clothes:
  - platform: template
    sensors:
      wash_machine_wet_clothes:
        friendly_name: Existe Roupa Lavada na Máquina
        #entity_id:
          #- input_datetime.task_washing_clothes_last_done
          #- input_datetime.task_washing_clothes_dry_last_done
        value_template: >
          {{ as_timestamp( states('input_datetime.task_washing_clothes_last_done') ) - as_timestamp( states('input_datetime.task_washing_clothes_dry_last_done') ) > 0 }} 
        attribute_templates:
          last_done: >
            {{ as_timestamp( states('input_datetime.task_washing_clothes_dry_last_done') ) | timestamp_custom("%Y-%m-%d %H:%M:%S", true) }}

      wash_machine_dry_clothes:
        friendly_name: Existe Roupa Seca Para Apanhar
        #entity_id:
          #- input_datetime.task_washing_clothes_dry_last_done
          #- input_datetime.task_washing_clothes_remove_last_done
        value_template: >
          {{ as_timestamp( states('input_datetime.task_washing_clothes_dry_last_done') ) - as_timestamp( states('input_datetime.task_washing_clothes_remove_last_done') ) > 0 }} 
        attribute_templates:
          last_done: >
            {{ as_timestamp( states('input_datetime.task_washing_clothes_remove_last_done') ) | timestamp_custom("%Y-%m-%d %H:%M:%S", true) }}

script:
  task_laundry_remove_wet_clothes:
    alias: Tarefa Retirar Roupa da Máquina
    sequence:
      - service: persistent_notification.dismiss
        data:
          notification_id: persistent_washing_maching
          
      - service: notify.mobile_app_all
        data:
          message: clear_notification
          data:
            tag: 20
            dismiss: true
      
      - condition: state
        entity_id: binary_sensor.wash_machine_wet_clothes
        state: "on"
            
      - service: input_datetime.set_datetime
        data_template:
          entity_id: input_datetime.task_washing_clothes_dry_last_done
          date: '{{ now().timestamp() | timestamp_custom("%Y-%m-%d", true) }}'
          time: '{{ now().timestamp() | timestamp_custom("%H:%M", true) }}'

  task_laundry_remove_dry_clothes:
    alias: Tarefa Apanhar Roupa do Estendal
    sequence:
      - service: input_datetime.set_datetime
        data_template:
          entity_id: input_datetime.task_washing_clothes_remove_last_done
          date: '{{ now().timestamp() | timestamp_custom("%Y-%m-%d", true) }}'
          time: '{{ now().timestamp() | timestamp_custom("%H:%M", true) }}'


automation clothes:
  - alias: Task Laundry Wash Machine Finished
    trigger:
      - entity_id: binary_sensor.washing_machine_state
        from: "on"
        platform: state
        to: "off"
    action:
      - service: input_datetime.set_datetime
        data_template:
          entity_id: input_datetime.task_washing_clothes_last_done
          date: '{{ now().timestamp() | timestamp_custom("%Y-%m-%d", true) }}'
          time: '{{ now().timestamp() | timestamp_custom("%H:%M", true) }}'
          
      - service: notify.living_room_tv
        data:
          title: Tarefa Doméstica
          message: Máquina de Lavar Roupa Terminou
          
      - service: automation.trigger
        data:
          entity_id: automation.task_laundry_remove_from_wash_machine_remainder
          skip_condition: true

  - alias: Task Laundry Remove From Wash Machine Remainder
    trigger:
      - platform: time_pattern
        minutes: 30
    condition:
      - condition: state
        entity_id: binary_sensor.wash_machine_wet_clothes
        state: "on"
      - condition: state
        entity_id: binary_sensor.notification_non_disturb
        state: "off"
    action:
      - service: persistent_notification.create
        data:
          title: Tarefa Doméstica
          message: Retirar roupa da máquina de lavar
          notification_id: persistent_washing_maching
          
      - service: notify.mobile_app_all
        data:
          title: Tarefa Doméstica
          message: Retirar roupa da máquina de lavar
          data:
            sticky: true
            tag: 20
            priority: high
            actions:
              - action: laundry_wet_clothes_done
                title: Registar roupa estendida

  - alias: Task Laundry Remove From Wash Machine Done
    trigger:
      - platform: state
        entity_id: binary_sensor.washing_machine_state
        from: "off"
        to: "on"
      - platform: state
        entity_id: binary_sensor.washing_machine_door
        from: "off"
        to: "on"
      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: laundry_wet_clothes_done
    condition:
      - condition: state
        entity_id: binary_sensor.wash_machine_wet_clothes
        state: "on"
    action:
      - service: script.task_laundry_remove_wet_clothes
