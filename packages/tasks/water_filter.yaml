################################################################
## Water Filter Replacement
################################################################
homeassistant:
  customize:
    sensor.water_filter_needs_replacement:
      icon: mdi:water
    sensor.water_filter_replacement_last_done:
      friendly_name: "Última Subtituição do Filtro da Água"
      device_class: timestamp

input_number:
  water_filter_replacement_days:
    name: Duração do Filtro da Água
    min: 0
    max: 120
    step: 1
    mode: box
    unit_of_measurement: days
    icon: mdi:timer-sand

sensor:
  - platform: sql
    db_url: !secret db_custom_url
    queries:
      - name: water_filter_replacement_last_done
        query: >-
          SELECT * FROM tasks
          WHERE task_name LIKE 'Water_Filter_Replacement'
          ORDER BY date  DESC LIMIT 1;
        column: date

  - platform: template
    sensors:
      water_filter_remaing_days:
        friendly_name: "Duração restante do Filtro da Água"
        unit_of_measurement: days
        value_template: >-
          {% set remaining_days = (((as_timestamp(states('sensor.water_filter_replacement_last_done')) - now().timestamp() ) / 3600 / 24 ) + states('input_number.water_filter_replacement_days') | float) | int %}
          {% if remaining_days < 0 %}
            0.0
          {% else %}
            {{ remaining_days }}
          {% endif %}

binary_sensor:
  - platform: template
    sensors:
      water_filter_needs_replacement:
        friendly_name: "Necessita de Substituição do Filtro da Água"
        device_class: problem
        icon_template: >-
          {% if is_state( 'binary_sensor.water_filter_needs_replacement', 'on' )  %}
            mdi:filter-off
          {% else %}
            mdi:filter
          {% endif %}
        value_template: >
          {{ (now().timestamp() - as_timestamp(states('sensor.water_filter_replacement_last_done'))) / 3600 / 24 >= states('input_number.water_filter_replacement_days') | float }}
        attribute_templates:
          last_done: >
            {{ as_timestamp( states('sensor.water_filter_replacement_last_done') ) | timestamp_custom("%Y-%m-%d %H:%M:%S", true) }}

script:
  task_water_filter_replacement_dismiss_notification:
    alias: Task Water Filter Replacement Dismiss Notification
    sequence:
      - service: persistent_notification.dismiss
        data:
          notification_id: persistent_water_filter_replacement
      - service: notify.mobile_app_all
        data:
          message: clear_notification
          data:
            tag: 10
            dismiss: true

  task_water_filter_replacement:
    alias: Task Water Filter Replacement
    sequence:
      - service: script.task_water_filter_replacement_dismiss_notification

      - service: shell_command.external_my_sql_insert
        data:
          table: tasks
          value: "Water_Filter_Replacement"
          column: task_name
          date_stamp: >
            "{{ now().timestamp() | timestamp_custom("%Y-%m-%d %H:%M:%S") }}"
          save_string: "true"
          save_date_time: "true"

automation old:
  - alias: task_water_filter_replacement_reminder
    trigger:
      - platform: event
        event_type: event_remaind_task_todo
    condition:
      - condition: state
        entity_id: binary_sensor.water_filter_needs_replacement
        state: "on"
      - condition: state
        entity_id: binary_sensor.notification_non_disturb
        state: "off"
      - condition: template
        value_template: >
          {{ now().timestamp() - this.attributes.last_triggered | as_timestamp > 60 * 50 }}
    action:
      - service: persistent_notification.create
        data:
          title: Tarefa Doméstica
          message: Trocar o Filtro do Jarro da Água
          notification_id: persistent_water_filter_replacement

      - service: script.task_notification
        data:
          task_message: Trocar o Filtro do Jarro da Água
          task_action: water_filter_replacement_mark_done
          task_action_message: Marcar como realizado
          task_id: 40

  - alias: task_water_filter_replacement_done
    trigger:
      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: water_filter_replacement_mark_done
    condition:
      - condition: state
        entity_id: binary_sensor.water_filter_needs_replacement
        state: "on"
    action:
      - service: script.task_water_filter_replacement
