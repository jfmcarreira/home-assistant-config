################################################################
## Power Consumption
################################################################
homeassistant:
  customize:
    sensor.daily_energy:
      device_class: energy
      state_class: total_increasing
    sensor.power_usage_lights:
      friendly_name: Potência Total das Luzes
      icon: mdi:flash
    sensor.power_usage_laundry:
      friendly_name: Potência do Sotão/Lavandaria
    sensor.energy_laundry:
      friendly_name: Energia do Sotão/Lavandaria
      device_class: energy
      state_class: total_increasing
    sensor.daily_energy_laundry:
      friendly_name: Energia Diária do Sotão/Lavandaria
    sensor.daily_energy_coffe_machine:
      friendly_name: Energia Diária da Máquina do Café
    sensor.energy_coffe_machine:
      friendly_name: Energia Máquina do Café
    sensor.energy_iron:
      device_class: energy
      state_class: total_increasing
    # sensor.energy_media_center:
    #   device_class: energy
    #   state_class: total_increasing
    sensor.energy_portable_heater:
      device_class: energy
      state_class: total_increasing
    sensor.daily_energy_media_center:
      friendly_name: Energia Diária do Centro Multimédia
    sensor.daily_energy_kitchen_oven:
      friendly_name: Energia Diária do Forno/Fogão
    sensor.kitchen_oven_energy:
      friendly_name: Energia Forno/Fogão
      device_class: energy
      state_class: total_increasing
    sensor.daily_energy_lights:
      friendly_name: Energia Diária das Luzes
    sensor.energy_lights:
      friendly_name: Energia Luzes
      device_class: energy
      state_class: total_increasing
    sensor.daily_energy_remaining:
      friendly_name: Energia Diária Restante
      device_class: energy
      state_class: total_increasing
  customize_glob:
    "sensor.daily_energy_*":
      icon: mdi:flash
  #"sensor.reative_power_usage_device_*":
  #device_class: power
  #unit_of_measurement: "VAR"
  #icon: mdi:flash-outline
  #"sensor.power_usage_reactive_*":
  #device_class: power
  #unit_of_measurement: "VAR"
  #icon: mdi:flash-outline
  #"sensor.power_usage_*":
  #device_class: power
  #unit_of_measurement: "W"
  #icon: mdi:flash
  #state_class: measurement
  #"sensor.daily_energy_*":
  #icon: mdi:flash-circle
  #unit_of_measurement: "kWh"
  #device_class: energy
  #state_class: total_increasing

  #device_class: energy
  #unit_of_measurement: "kWh"
  #state_class: total_increasing

utility_meter:
  # daily_energy_remaining:
  #   source: sensor.energy_remaining
  #   cycle: daily
  #daily_energy_living_room:
  #source: sensor.living_room_energy
  #cycle: daily
  daily_energy_laundry:
    source: sensor.energy_laundry
    cycle: daily
  daily_energy_kitchen_oven:
    source: sensor.kitchen_oven_energy
    cycle: daily
  daily_energy_iron:
    source: sensor.energy_iron
    cycle: daily
  # daily_energy_office_desk:
  #   source: sensor.energy_office_desk
  #   cycle: daily
  # daily_energy_media_center:
  #   source: sensor.energy_media_center
  #   cycle: daily
  daily_energy_portable_heater:
    source: sensor.energy_portable_heater
    cycle: daily
  daily_energy_lights:
    source: sensor.energy_lights
    cycle: daily

sensor:
  - platform: template
    sensors:
      power_usage_laundry:
        unit_of_measurement: "W"
        value_template: >
          {{  ( states('sensor.power_usage_laundry_main') | float ) - 
              ( states('sensor.power_usage_device_washing_machine') | float ) - 
              ( states('sensor.power_usage_device_dryer_machine') | float )}}

      energy_portable_heater:
        unit_of_measurement: "kWh"
        device_class: energy
        #state_class: total_increasing
        value_template: >
          {{ states('sensor.energy_portable_heater_raw') | float * 0.01 }}

      # energy_media_center:
      #   unit_of_measurement: "kWh"
      #   device_class: energy
      #   #state_class: total_increasing
      #   value_template: >
      #     {{ states('sensor.energy_media_center_raw') | float * 0.01 }}

      energy_iron:
        unit_of_measurement: "kWh"
        device_class: energy
        value_template: >
          {{ states('sensor.energy_iron_raw') | float * 0.01 }}

      energy_office_desk_non_critical:
        unit_of_measurement: "kWh"
        value_template: >
          {{ states('sensor.energy_office_desk_non_critical_raw') | float * 0.01 }}

      # energy_laundry:
      #   unit_of_measurement: "kWh"
      #   value_template: >
      #     {{ ( states('sensor.energy_laundry_main') | float ) - ( states('sensor.energy_washing_machine') | float ) }}

      power_usage_lights:
        friendly_name: "Potência das Luzes"
        unit_of_measurement: "W"
        value_template: >
          {{ ((
            ( states('sensor.power_usage_light_kitchen') | float ) +
            ( states('sensor.power_usage_light_kitchen_pantry') | float ) +
            ( states('sensor.power_usage_light_living_room_table') | float ) +
            ( states('sensor.power_usage_light_living_room_window') | float ) +
            ( states('sensor.power_usage_light_master_bedroom') | float ) +
            ( states('sensor.power_usage_light_master_bedroom_bathroom_ceiling') | float ) +
            ( states('sensor.power_usage_light_master_bedroom_bathroom_mirror') | float ) +
            ( states('sensor.power_usage_light_hallway') | float ) +
            ( states('sensor.power_usage_light_front_door') | float ) +
            ( states('sensor.power_usage_light_ricardo_lamp') | float )
            ) | int )
          }}

      daily_energy_remaining:
        friendly_name: "Energia Diária Restante"
        unit_of_measurement: "kWh"
        value_template: >
          {{
            max(
              ( states('sensor.daily_energy') | float ) -
              ( states('sensor.daily_energy_server') | float ) -
              ( states('sensor.daily_energy_office_desk') | float ) -
              ( states('sensor.daily_energy_kitchen_oven') | float ) -
              ( states('sensor.daily_energy_microwave') | float ) -
              ( states('sensor.daily_energy_coffe_machine') | float ) -
              ( states('sensor.daily_energy_washing_machine') | float ) -
              ( states('sensor.daily_energy_dish_wash_machine') | float ) -
              ( states('sensor.daily_energy_dryer_machine') | float ) -
              ( states('sensor.daily_energy_fridge') | float ) -
              ( states('sensor.daily_energy_laundry') | float ) -
              ( states('sensor.daily_energy_iron') | float ) -
              ( states('sensor.daily_energy_portable_heater') | float ) -
              ( states('sensor.daily_energy_vacuum_chargers') | float ) -
              ( states('sensor.daily_energy_lights') | float )
            , 0.0) | round(3)
          }}
        attribute_templates:
          last_reset: "{{ state_attr('sensor.daily_energy','last_reset') }}"

  - platform: integration
    source: sensor.power_usage_laundry
    name: energy_laundry
    unit_prefix: k
    unit_time: h
    round: 2

  #- platform: integration
  #source: sensor.power_usage_device_media_center
  #name: energy_media_center
  #unit_prefix: k
  #unit_time: h
  #round: 2

  # - platform: integration
  #   source: sensor.power_usage_device_office_desk
  #   name: energy_office_desk
  #   unit_prefix: k
  #   unit_time: h
  #   round: 2

  - platform: integration
    source: sensor.power_usage_lights
    name: energy_lights
    unit_prefix: k
    unit_time: h
    round: 2

automation insert:
  - alias: "Daily Stats Insert Value of Partial Energy of to Database"
    initial_state: true
    mode: queued
    max: 20
    trigger:
      - platform: state
        entity_id: sensor.daily_energy
      - platform: state
        entity_id: sensor.daily_energy_living_room
      - platform: state
        entity_id: sensor.daily_energy_media_center
      - platform: state
        entity_id: sensor.daily_energy_laundry
      - platform: state
        entity_id: sensor.daily_energy_kitchen_oven
      - platform: state
        entity_id: sensor.daily_energy_coffe_machine
      - platform: state
        entity_id: sensor.daily_energy_microwave
      - platform: state
        entity_id: sensor.daily_energy_dish_wash_machine
      - platform: state
        entity_id: sensor.daily_energy_washing_machine
      - platform: state
        entity_id: sensor.daily_energy_dryer_machine
      - platform: state
        entity_id: sensor.daily_energy_fridge
      - platform: state
        entity_id: sensor.daily_energy_office_desk
      #- platform: state
      #entity_id: sensor.daily_energy_iron
      - platform: state
        entity_id: sensor.daily_energy_portable_heater
      - platform: state
        entity_id: sensor.daily_energy_xmas_tree
      - platform: state
        entity_id: sensor.daily_energy_lights
      - platform: state
        entity_id: sensor.daily_energy_server
      - platform: state
        entity_id: sensor.daily_energy_remaining
    action:
      - service: shell_command.external_my_sql_insert
        data_template:
          table: daily_energy_partial
          value: >
            {{ trigger.to_state.state }}
          column: >
            {% if trigger.entity_id == "sensor.daily_energy" %}
              daily_energy_total
            {% elif trigger.entity_id == "sensor.daily_energy_living_room" %}
              daily_energy_living_room
            {% elif trigger.entity_id == "sensor.daily_energy_media_center" %}
              daily_energy_media_center
            {% elif trigger.entity_id == "sensor.daily_energy_laundry" %}
              daily_energy_laundry
            {% elif trigger.entity_id == "sensor.daily_energy_kitchen_oven" %}
              daily_energy_kitchen_oven
            {% elif trigger.entity_id == "sensor.daily_energy_coffe_machine" %}
              daily_energy_coffe_machine
            {% elif trigger.entity_id == "sensor.daily_energy_microwave" %}
              daily_energy_microwave
            {% elif trigger.entity_id == "sensor.daily_energy_dish_wash_machine" %}
              daily_energy_dish_wash_machine
            {% elif trigger.entity_id == "sensor.daily_energy_washing_machine" %}
              daily_energy_washing_machine
            {% elif trigger.entity_id == "sensor.daily_energy_dryer_machine" %}
              daily_energy_dryer_machine
            {% elif trigger.entity_id == "sensor.daily_energy_fridge" %}
              daily_energy_fridge
            {% elif trigger.entity_id == "sensor.daily_energy_office_desk" %}
              daily_energy_office_desk
            {% elif trigger.entity_id == "sensor.daily_energy_iron" %}
              daily_energy_iron
            {% elif trigger.entity_id == "sensor.daily_energy_portable_heater" %}
              daily_energy_portable_heater
            {% elif trigger.entity_id == "sensor.daily_energy_xmas_tree" %}
              daily_energy_xmas_tree
            {% elif trigger.entity_id == "sensor.daily_energy_lights" %}
              daily_energy_lights
            {% elif trigger.entity_id == "sensor.daily_energy_server" %}
              daily_energy_server
            {% elif trigger.entity_id == "sensor.daily_energy_remaining" %}
              daily_energy_remaining
            {% endif %}
