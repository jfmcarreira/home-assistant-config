- binary_sensor:
    #  washing_machine_state:
    #       device_class: plug
    #       delay_off:
    #         minutes: 5
    #       value_template: >-
    #         {%- if ( states("sensor.power_usage_laundry_main") | int > 20 ) and ( states("sensor.reative_power_usage_laundry_main") | float | abs > 30 ) %}
    #             True
    #         {%- else %}
    #             False
    #         {%- endif %}
    #       attribute_templates:
    #         Ãšltima Lavagem: "{{ as_timestamp( states('sensor.task_washing_clothes_last_done') ) | timestamp_custom('%Y-%m-%d %H:%M:%S', true) }}"

    - name: washing_machine_state
      unique_id: washing_machine_state
      icon: mdi:washing-machine
      device_class: plug
      delay_on:
        minutes: 1
      delay_off:
        minutes: 2
      state: >-
        {% if is_state( 'binary_sensor.washing_machine_state', 'on' )  %}
            {%- if states("sensor.power_usage_device_washing_machine") | int < 3 %}
                False
            {%- else %}
                True
            {%- endif %}
        {%- else %}
            {%- if states("sensor.power_usage_device_washing_machine") | int > 50 %}
                True
            {%- else %}
                False
            {%- endif %}
        {%- endif %}
      attributes:
        Secagem da Roupa: >
          {{ as_timestamp( states('sensor.task_dryer_last_done') ) | timestamp_custom("%Y-%m-%d %H:%M:%S", true) }}

    - name: wash_machine_wet_clothes
      unique_id: wash_machine_wet_clothes
      icon: mdi:hanger
      state: "{{ as_timestamp( states('sensor.task_washing_clothes_last_done') ) - as_timestamp( states('sensor.task_washing_clothes_dry_last_done') ) > 0 }}"
      attributes:
        Energia: "{{ states('sensor.energy_washing_machine') }}"
        Roupa Retirada: "{{ as_timestamp( states('sensor.task_washing_clothes_dry_last_done') ) | timestamp_custom('%Y-%m-%d %H:%M:%S', true) }}"

    - name: wash_machine_dry_clothes
      unique_id: wash_machine_dry_clothes
      state: "{{ as_timestamp( states('sensor.task_washing_clothes_dry_last_done') ) - as_timestamp( states('sensor.task_washing_clothes_remove_last_done') ) > 0 }}"
      icon: mdi:tshirt-crew
      attributes:
        Roupa Apanhada: "{{ as_timestamp( states('sensor.task_washing_clothes_remove_last_done') ) | timestamp_custom('%Y-%m-%d %H:%M:%S', true) }}"

- sensor:
    - name: washing_machine_state
      unique_id: washing_machine_state
      state: >-
        {% if is_state( 'binary_sensor.washing_machine_door', 'on' )  %}
          Aberta
        {% else %}
          {% if is_state( 'binary_sensor.washing_machine_state', 'on' )  %}
            A Lavar
          {% elif is_state( 'binary_sensor.wash_machine_wet_clothes', 'on' )  %}
            Roupa Lavada
          {% else %}
            Desligada
          {% endif %}
        {% endif %}
      icon: >-
        {% if is_state( 'binary_sensor.washing_machine_state', 'on' )  %}
            mdi:washing-machine
        {% elif is_state( 'binary_sensor.wash_machine_wet_clothes', 'on' )  %}
          mdi:washing-machine-alert
        {% else %}
          mdi:washing-machine-off
        {% endif %}
